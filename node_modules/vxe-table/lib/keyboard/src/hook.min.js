"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTargetOffset(e,t){var o,l,n=0,r=0,c=!_dom.browse.firefox&&(0,_dom.hasClass)(e,"vxe-checkbox--label");for(c&&(o=getComputedStyle(e),n-=_xeUtils.default.toNumber(o.paddingTop),r-=_xeUtils.default.toNumber(o.paddingLeft));e&&e!==t;)n+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent,c&&(l=getComputedStyle(e),n-=_xeUtils.default.toNumber(l.paddingTop),r-=_xeUtils.default.toNumber(l.paddingLeft));return{offsetTop:n,offsetLeft:r}}var tableKeyboardHook={setupTable:function(y){var f=y.props,k=y.reactData,H=y.internalData,E=y.getRefMaps().refElem,e=y.getComputeMaps(),g=e.computeEditOpts,u=e.computeCheckboxOpts,i=e.computeMouseOpts,s=e.computeTreeOpts;function d(e,a){var t,u,i,o,s,d,l,n,f,g,m,h,p,v,x,w,b,T,C,R,_,I,r,c=a.column,M=a.cell;"checkbox"===c.type&&(t=E.value,o=H.elemStore,u=e.clientX,i=e.clientY,o=o["".concat(c.fixed||"main","-body-wrapper")]||o["main-body-wrapper"],(s=o?o.value:null)&&(d=s.querySelector(".vxe-table--checkbox-range"),l=document.onmousemove,n=document.onmouseup,f=M.parentNode,g=y.getCheckboxRecords(),m=[],h=1,M=getTargetOffset(e.target,s),p=M.offsetTop+e.offsetY,v=M.offsetLeft+e.offsetX,x=s.scrollTop,w=f.offsetHeight,b=null,C=1,R=function(e,t){y.dispatchEvent("checkbox-range-".concat(e),{records:y.getCheckboxRecords(),reserves:y.getCheckboxReserveRecords()},t)},_=function(e){var t=e.clientX,o=e.clientY,l=t-u,n=o-i+(s.scrollTop-x),r=Math.abs(n),c=Math.abs(l),t=p,o=v;n<h?(t+=n)<h&&(t=h,r=p):r=Math.min(r,s.scrollHeight-p-h),l<h?(o+=l,v<c&&(o=h,c=v)):c=Math.min(c,s.clientWidth-v-h),d.style.height="".concat(r,"px"),d.style.width="".concat(c,"px"),d.style.left="".concat(o,"px"),d.style.top="".concat(t,"px"),d.style.display="block";n=function(e,t,o){var l=0,n=[],r=0<o,c=0<o?o:Math.abs(o)+t.offsetHeight,a=k.scrollYLoad,u=H.afterFullData,o=H.scrollYStore;if(a)e=y.getVTRowIndex(e.row),n=r?u.slice(e,e+Math.ceil(c/o.rowHeight)):u.slice(e-Math.floor(c/o.rowHeight)+1,e+1);else for(var i=r?"next":"previous";t&&l<c;){var s=y.getRowNode(t);s&&(n.push(s.item),l+=t.offsetHeight,t=t["".concat(i,"ElementSibling")])}return n}(a,f,n<h?-r:r);10<r&&n.length!==m.length&&(m=n,e.ctrlKey?n.forEach(function(e){y.handleSelectRow({row:e},-1===g.indexOf(e))}):(y.setAllCheckboxRow(!1),y.setCheckboxRow(n,!0)),R("change",e))},I=function(){clearTimeout(b),b=null},(T=!(r=function r(c){I(),b=setTimeout(function(){var e,t,o,l,n;b&&(e=s.scrollLeft,t=s.scrollTop,o=s.clientHeight,l=s.scrollHeight,n=Math.ceil(50*C/w),T?t+o<l?(y.scrollTo(e,t+n),r(c),_(c)):I():t?(y.scrollTo(e,t-n),r(c),_(c)):I())},50)}),_dom.addClass)(t,"drag--range"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var t=e.clientY,o=(0,_dom.getAbsolutePos)(s).boundingTop;t<o?(T=!1,C=o-t,b||r(e)):t>o+s.clientHeight?(T=!0,C=t-o-s.clientHeight,b||r(e)):b&&I(),_(e)},document.onmouseup=function(e){I(),(0,_dom.removeClass)(t,"drag--range"),d.removeAttribute("style"),document.onmousemove=l,document.onmouseup=n,R("end",e)},R("start",e)))}return{moveTabSelected:function(e,t,o){var l,n,r,c=f.editConfig,a=H.afterFullData,u=H.visibleColumn,i=g.value,s=Object.assign({},e),d=y.getVTRowIndex(s.row),e=y.getVTColumnIndex(s.column);o.preventDefault(),t?e<=0?0<d&&(l=a[n=d-1],r=u.length-1):r=e-1:e>=u.length-1?d<a.length-1&&(l=a[n=d+1],r=0):r=e+1;u=u[r];u&&(l?(s.rowIndex=n,s.row=l):s.rowIndex=d,s.columnIndex=r,s.column=u,s.cell=y.getCell(s.row,s.column),c?"click"!==i.trigger&&"dblclick"!==i.trigger||("row"===i.mode?y.handleActived(s,o):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)})):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)}))},moveCurrentRow:function(e,t,o){var l,n,r,c=f.treeConfig,a=k.currentRow,u=H.afterFullData,i=s.value;o.preventDefault(),a?c?(n=(i=_xeUtils.default.findTree(u,function(e){return e===a},i)).index,i=i.items,e&&0<n?l=i[n-1]:t&&n<i.length-1&&(l=i[n+1])):(n=y.getVTRowIndex(a),e&&0<n?l=u[n-1]:t&&n<u.length-1&&(l=u[n+1])):l=u[0],l&&(r={$table:y,row:l,rowIndex:y.getRowIndex(l),$rowIndex:y.getVMRowIndex(l)},y.scrollToRow(l).then(function(){return y.triggerCurrentRowEvent(o,r)}))},moveSelected:function(e,t,o,l,n,r){var c=H.afterFullData,a=H.visibleColumn,u=Object.assign({},e),i=y.getVTRowIndex(u.row),e=y.getVTColumnIndex(u.column);r.preventDefault(),o&&0<i?(u.rowIndex=i-1,u.row=c[u.rowIndex]):n&&i<c.length-1?(u.rowIndex=i+1,u.row=c[u.rowIndex]):t&&e?(u.columnIndex=e-1,u.column=a[u.columnIndex]):l&&e<a.length-1&&(u.columnIndex=e+1,u.column=a[u.columnIndex]),y.scrollToRow(u.row,u.column).then(function(){u.cell=y.getCell(u.row,u.column),y.handleSelected(u,r)})},triggerHeaderCellMousedownEvent:function(e,t){var o,l=f.mouseConfig,n=i.value;l&&n.area&&y.handleHeaderCellAreaEvent&&(o=e.currentTarget,l=(0,_dom.getEventTargetNode)(e,o,"vxe-cell--sort").flag,n=(0,_dom.getEventTargetNode)(e,o,"vxe-cell--filter").flag,y.handleHeaderCellAreaEvent(e,Object.assign({cell:o,triggerSort:l,triggerFilter:n},t))),y.focus(),y.closeMenu&&y.closeMenu()},triggerCellMousedownEvent:function(e,t){var o=e.currentTarget;t.cell=o,function(e,t){var o=f.editConfig,l=f.checkboxConfig,n=f.mouseConfig,r=u.value,c=i.value,a=g.value;if(n&&c.area&&y.handleCellAreaEvent)return y.handleCellAreaEvent(e,t);l&&r.range&&d(e,t),n&&c.selected&&(o&&"cell"!==a.mode||y.handleSelected(t,e))}(e,t),y.focus(),y.closeFilter(),y.closeMenu&&y.closeMenu()}}}},_default=tableKeyboardHook;exports.default=_default;