"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_xeUtils=_interopRequireDefault(require("xe-utils")),_utils=require("../../tools/utils"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,l=arguments.length;r<l;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"content",{get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.content},enumerable:!1,configurable:!0}),e}(),tableValidatorMethodKeys=["fullValidate","validate","clearValidate"],validatorHook={setupTable:function(f){function r(e,o,l){var a={},n=v.editRules,s=v.treeConfig,c=m.afterFullData,t=x.value,d=_.value;!0===e?r=c:e&&(_xeUtils.default.isFunction(e)?o=e:r=_xeUtils.default.isArray(e)?e:[e]);var r=r||(f.getInsertRecords?f.getInsertRecords().concat(f.getUpdateRecords()):[]),i=[];if(m._lastCallTime=Date.now(),g=!1,w.clearValidate(),n){var u=f.getColumns(),e=function(r){var e;!l&&g||(e=[],u.forEach(function(t){!l&&g||!_xeUtils.default.has(n,t.property)||e.push(y.validCellRules("all",r,t).catch(function(e){e={rule:e.rule,rules:e.rules,rowIndex:f.getRowIndex(r),row:r,columnIndex:f.getColumnIndex(t),column:t,field:t.property,$table:f};if(a[t.property]||(a[t.property]=[]),a[t.property].push(e),!l)return g=!0,Promise.reject(e)}))}),i.push(Promise.all(e)))};return s?_xeUtils.default.eachTree(r,e,t):r.forEach(e),Promise.all(i).then(function(){var e=Object.keys(a);return(0,_vue.nextTick)().then(function(){return e.length?Promise.reject(a[e[0]][0]):void(o&&o())})}).catch(function(u){return new Promise(function(e,t){function r(){var t;u.cell=f.getCell(u.row,u.column),(0,_dom.scrollToView)(u.cell),t=u,new Promise(function(e){!1===_.value.autoPos?(f.dispatchEvent("valid-error",t,null),e()):f.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(y.showValidTooltip(t))},10)})}).then(l)}var l=function(){(0,_vue.nextTick)(function(){o?(o(a),e()):("obsolete"===_conf.default.validToReject?t:e)(a)})},n=u.row,i=c.indexOf(n),n=0<i?c[i-1]:n;!1===d.autoPos?l():(s?f.scrollToTreeRow(n):f.scrollToRow(n)).then(r)})})}return(0,_vue.nextTick)().then(function(){o&&o()})}function p(e,t){var r=e.type,l=e.min,n=e.max,i=e.pattern,r=(e="number"===r)?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||(!_xeUtils.default.eqNull(l)&&r<_xeUtils.default.toNumber(l)||(!_xeUtils.default.eqNull(n)&&r>_xeUtils.default.toNumber(n)||!(!i||(_xeUtils.default.isRegExp(i)?i:new RegExp(i)).test(t))))}var g,v=f.props,d=f.reactData,m=f.internalData,h=f.getRefMaps().refValidTooltip,e=f.getComputeMaps(),_=e.computeValidOpts,x=e.computeTreeOpts,s=e.computeEditOpts,w={},y={},y={validCellRules:function(i,u,o,e){var a,s,t=v.editRules,r=o.property,c=[],d=[];return r&&t&&((a=_xeUtils.default.get(t,r))&&(s=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(u,r):e,a.forEach(function(t){var e,r=t.type,l=t.trigger,n=t.required;"all"!==i&&l&&i!==l||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({cellValue:s,rule:t,rules:a,row:u,rowIndex:f.getRowIndex(u),column:o,columnIndex:f.getColumnIndex(o),field:o.property,$table:f}))&&(_xeUtils.default.isError(e)?(g=!0,c.push(new Rule({type:"custom",trigger:l,content:e.message,rule:new Rule(t)}))):e.catch&&d.push(e.catch(function(e){g=!0,c.push(new Rule({type:"custom",trigger:l,content:e&&e.message?e.message:t.content||t.message,rule:new Rule(t)}))}))):(r="array"===r||_xeUtils.default.isArray(s)?!_xeUtils.default.isArray(s)||!s.length:(0,_utils.eqEmptyValue)(s),(n?r||p(t,s):!r&&p(t,s))&&(g=!0,c.push(new Rule(t)))))}))),Promise.all(d).then(function(){if(c.length){var e={rules:c,rule:c[0]};return Promise.reject(e)}})},hasCellRules:function(t,e,r){var l=v.editRules,r=r.property;if(r&&l){r=_xeUtils.default.get(l,r);return r&&!!_xeUtils.default.find(r,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},triggerValidate:function(t){var e=v.editConfig,r=v.editRules,l=d.editStore,n=d.validStore,l=l.actived,i=s.value;if(e&&r&&l.row){var l=l.args,u=l.row,o=l.column,a=l.cell;if(y.hasCellRules(t,u,o))return y.validCellRules(t,u,o).then(function(){"row"===i.mode&&n.visible&&n.row===u&&n.column===o&&w.clearValidate()}).catch(function(e){e=e.rule;if(e.trigger&&t!==e.trigger)return Promise.resolve();e={rule:e,row:u,column:o,cell:a};return y.showValidTooltip(e),Promise.reject(e)})}return Promise.resolve()},showValidTooltip:function(e){var t=v.height,r=d.tableData,l=d.validStore,n=_.value,i=e.rule,u=e.row,o=e.column,a=e.cell,s=h.value,c=i.content;return(0,_vue.nextTick)().then(function(){if(Object.assign(l,{row:u,column:o,rule:i,content:c,visible:!0}),f.dispatchEvent("valid-error",e,null),s&&("tooltip"===n.message||"default"===n.message&&!t&&r.length<2))return s.open(a,c)})}};return __assign(__assign({},w={fullValidate:function(e,t){return r(e,t,!0)},validate:function(e,t){return r(e,t)},clearValidate:function(){var e=d.validStore,t=h.value;return Object.assign(e,{visible:!1,row:null,column:null,content:"",rule:null}),t&&t.reactData.visible&&t.close(),(0,_vue.nextTick)()}}),y)},setupGrid:function(e){return e.extendTableMethods(tableValidatorMethodKeys)}},_default=validatorHook;exports.default=_default;