"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.msgQueue=exports.default=exports.allActivedModals=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_event=require("../../tools/event"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_button=_interopRequireDefault(require("../../button/src/button")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},allActivedModals=[];exports.allActivedModals=allActivedModals;var msgQueue=[];exports.msgQueue=msgQueue;var _default2=(0,_vue.defineComponent)({name:"VxeModal",props:{modelValue:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:function(){return _conf.default.modal.top}},position:[String,Object],title:String,duration:{type:[Number,String],default:function(){return _conf.default.modal.duration}},message:[Number,String],content:[Number,String],cancelButtonText:{type:String,default:function(){return _conf.default.modal.cancelButtonText}},confirmButtonText:{type:String,default:function(){return _conf.default.modal.confirmButtonText}},lockView:{type:Boolean,default:function(){return _conf.default.modal.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return _conf.default.modal.mask}},maskClosable:{type:Boolean,default:function(){return _conf.default.modal.maskClosable}},escClosable:{type:Boolean,default:function(){return _conf.default.modal.escClosable}},resize:Boolean,showHeader:{type:Boolean,default:function(){return _conf.default.modal.showHeader}},showFooter:{type:Boolean,default:function(){return _conf.default.modal.showFooter}},showZoom:Boolean,showClose:{type:Boolean,default:function(){return _conf.default.modal.showClose}},dblclickZoom:{type:Boolean,default:function(){return _conf.default.modal.dblclickZoom}},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:function(){return _conf.default.modal.minWidth}},minHeight:{type:[Number,String],default:function(){return _conf.default.modal.minHeight}},zIndex:Number,marginSize:{type:[Number,String],default:function(){return _conf.default.modal.marginSize}},fullscreen:Boolean,draggable:{type:Boolean,default:function(){return _conf.default.modal.draggable}},remember:{type:Boolean,default:function(){return _conf.default.modal.remember}},destroyOnClose:{type:Boolean,default:function(){return _conf.default.modal.destroyOnClose}},showTitleOverflow:{type:Boolean,default:function(){return _conf.default.modal.showTitleOverflow}},transfer:{type:Boolean,default:function(){return _conf.default.modal.transfer}},storage:{type:Boolean,default:function(){return _conf.default.modal.storage}},storageKey:{type:String,default:function(){return _conf.default.modal.storageKey}},animat:{type:Boolean,default:function(){return _conf.default.modal.animat}},size:{type:String,default:function(){return _conf.default.modal.size||_conf.default.size}},beforeHideMethod:{type:Function,default:function(){return _conf.default.modal.beforeHideMethod}},slots:Object},emits:["update:modelValue","show","hide","before-hide","close","confirm","cancel","zoom"],setup:function(N,e){function a(){var e=N.width,t=N.height,o=O();return o.style.width="".concat(e?isNaN(e)?e:"".concat(e,"px"):""),o.style.height="".concat(t?isNaN(t)?t:"".concat(t,"px"):""),(0,_vue.nextTick)()}function d(){return(0,_vue.nextTick)().then(function(){var e=N.position,t=_xeUtils.default.toNumber(N.marginSize),o=O(),n=document.documentElement.clientWidth||document.body.clientWidth,i=document.documentElement.clientHeight||document.body.clientHeight,a="center"===e,l=_xeUtils.default.isString(e)?{top:e,left:e}:Object.assign({},e),u=l.top,c=l.left,s=a||"center"===u,e="",l="",l=c&&!(a||"center"===c)?isNaN(c)?c:"".concat(c,"px"):"".concat(Math.max(t,n/2-o.offsetWidth/2),"px"),e=u&&!s?isNaN(u)?u:"".concat(u,"px"):"".concat(Math.max(t,i/2-o.offsetHeight/2),"px");o.style.top=e,o.style.left=l})}function l(e){var t="close";S.dispatchEvent(t,{type:t},e),C(t)}function t(e){var t="confirm";S.dispatchEvent(t,{type:t},e),C(t)}function o(e){var t="cancel";S.dispatchEvent(t,{type:t},e),C(t)}function f(){return(0,_vue.nextTick)().then(function(){var e,t,o,n;k.zoomLocat||(e=Math.max(0,_xeUtils.default.toNumber(N.marginSize)),t=O(),o=(n=(0,_dom.getDomNode)()).visibleHeight,n=n.visibleWidth,k.zoomLocat={top:t.offsetTop,left:t.offsetLeft,width:t.offsetWidth+(t.style.width?0:1),height:t.offsetHeight+(t.style.height?0:1)},Object.assign(t.style,{top:"".concat(e,"px"),left:"".concat(e,"px"),width:"".concat(n-2*e,"px"),height:"".concat(o-2*e,"px")}),V())})}function n(){var e=N.duration,r=N.remember,o=N.showFooter,t=k.inited,n=k.visible,i=T.value;return t||(k.inited=!0),n||(r||a(),k.visible=!0,k.contentVisible=!1,B(),allActivedModals.push(z),setTimeout(function(){k.contentVisible=!0,(0,_vue.nextTick)(function(){var e;o&&(e=v.value,t=y.value,(t=e||t)&&t.focus());var t={type:""};m("update:modelValue",!0),S.dispatchEvent("show",t)})},10),i?(-1===msgQueue.indexOf(z)&&msgQueue.push(z),M(),-1!==e&&setTimeout(function(){return C("close")},_xeUtils.default.toNumber(e))):(0,_vue.nextTick)(function(){var e,t,o,n,i,a,l,u,c=N.fullscreen,s=k.firstOpen;r&&!s||d().then(function(){setTimeout(d,20)}),s?(k.firstOpen=!1,i=N.id,a=N.remember,l=N.storage,u=N.storageKey,i&&a&&l&&E(u)[i]?(e=N.id,t=N.remember,o=N.storage,n=N.storageKey,e&&t&&o&&((s=E(n)[e])&&(a=O(),u=(l=s.split(","))[0],i=l[1],t=l[2],o=l[3],n=l[4],e=l[5],s=l[6],l=l[7],u&&(a.style.left="".concat(u,"px")),i&&(a.style.top="".concat(i,"px")),t&&(a.style.width="".concat(t,"px")),o&&(a.style.height="".concat(o,"px")),n&&e&&(k.zoomLocat={left:n,top:e,width:s,height:l})))):c&&(0,_vue.nextTick)(f)):c&&(0,_vue.nextTick)(f)})),(0,_vue.nextTick)()}function p(e){var t=x.value;N.maskClosable&&e.target===t&&C("mask")}function i(e){var t;!(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE)||(t=_xeUtils.default.max(allActivedModals,function(e){return e.reactData.modalZindex}))&&setTimeout(function(){t===z&&t.props.escClosable&&C("exit")},10)}function u(){return!!k.zoomLocat}function c(){return(0,_vue.nextTick)().then(function(){var e,t=k.zoomLocat;t&&(e=O(),k.zoomLocat=null,Object.assign(e.style,{top:"".concat(t.top,"px"),left:"".concat(t.left,"px"),width:"".concat(t.width,"px"),height:"".concat(t.height,"px")}),V())})}function s(){return(k.zoomLocat?c:f)().then(u)}function h(){var t=k.modalZindex;allActivedModals.some(function(e){return e.reactData.visible&&e.reactData.modalZindex>t})&&B()}var _=e.slots,m=e.emit,r=_xeUtils.default.uniqueId(),g=(0,_size.useSize)(N),k=(0,_vue.reactive)({inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!0}),x=(0,_vue.ref)(),b=(0,_vue.ref)(),v=(0,_vue.ref)(),y=(0,_vue.ref)(),w={refElem:x},z={xID:r,props:N,context:e,reactData:k,getRefMaps:function(){return w}},S={},T=(0,_vue.computed)(function(){return"message"===N.type}),O=function(){return b.value},B=function(){var e=N.zIndex,t=k.modalZindex;e?k.modalZindex=e:t<(0,_utils.getLastZIndex)()&&(k.modalZindex=(0,_utils.nextZIndex)())},M=function(){(0,_vue.nextTick)(function(){var o=0;msgQueue.forEach(function(e){var t=e.getBox();o+=_xeUtils.default.toNumber(e.props.top),e.reactData.modalTop=o,o+=t.clientHeight})})},L=function(){-1<msgQueue.indexOf(z)&&_xeUtils.default.remove(msgQueue,function(e){return e===z}),M()},C=function(e){var t=N.remember,o=N.beforeHideMethod,n=k.visible,i=T.value,a={type:e};return n&&Promise.resolve(o?o(a):null).then(function(e){_xeUtils.default.isError(e)||(i&&L(),k.contentVisible=!1,t||(k.zoomLocat=null),_xeUtils.default.remove(allActivedModals,function(e){return e===z}),S.dispatchEvent("before-hide",a),setTimeout(function(){k.visible=!1,m("update:modelValue",!1),S.dispatchEvent("hide",a)},200))}).catch(function(e){return e}),(0,_vue.nextTick)()},E=function(e){var t=_conf.default.version,e=_xeUtils.default.toStringJSON(localStorage.getItem(e)||"");return e&&e._v===t?e:{_v:t}},V=function(){var e=N.id,t=N.remember,o=N.storage,n=N.storageKey,i=k.zoomLocat;e&&t&&o&&(t=O(),(o=E(n))[e]=[t.style.left,t.style.top,t.style.width,t.style.height].concat(i?[i.left,i.top,i.width,i.height]:[]).map(function(e){return e?_xeUtils.default.toNumber(e):""}).join(","),localStorage.setItem(n,_xeUtils.default.toJSONString(o)))},D=function(e){var t={type:k.zoomLocat?"revert":"max"};return s().then(function(){S.dispatchEvent("zoom",t,e)})},U=function(e){var t,o,i,a,l,u,n=N.remember,c=N.storage,s=k.zoomLocat,r=_xeUtils.default.toNumber(N.marginSize),d=O();s||0!==e.button||(0,_dom.getEventTargetNode)(e,d,"trigger--btn").flag||(e.preventDefault(),t=document.onmousemove,o=document.onmouseup,i=e.clientX-d.offsetLeft,a=e.clientY-d.offsetTop,e=(0,_dom.getDomNode)(),l=e.visibleHeight,u=e.visibleWidth,document.onmousemove=function(e){e.preventDefault();var t=d.offsetWidth,o=d.offsetHeight,n=u-t-r-1,t=l-o-r-1,o=e.clientX-i,e=e.clientY-a;(e=t<e?t:e)<r&&(e=r),d.style.left="".concat(o=(o=n<o?n:o)<r?r:o,"px"),d.style.top="".concat(e,"px"),d.className=d.className.replace(/\s?is--drag/,"")+" is--drag"},document.onmouseup=function(){document.onmousemove=t,document.onmouseup=o,n&&c&&(0,_vue.nextTick)(function(){V()}),setTimeout(function(){d.className=d.className.replace(/\s?is--drag/,"")},50)})},H=function(e){e.preventDefault();var a=N.remember,l=N.storage,t=(0,_dom.getDomNode)(),u=t.visibleHeight,c=t.visibleWidth,s=_xeUtils.default.toNumber(N.marginSize),r=e.target.getAttribute("type"),d=_xeUtils.default.toNumber(N.minWidth),f=_xeUtils.default.toNumber(N.minHeight),m=c,v=u,p=O(),o=document.onmousemove,n=document.onmouseup,h=p.clientWidth,_=p.clientHeight,g=e.clientX,x=e.clientY,b=p.offsetTop,y=p.offsetLeft,w={type:"resize"};document.onmousemove=function(e){var t,o,n,i;switch(e.preventDefault(),r){case"wl":n=(t=g-e.clientX)+h,s<y-t&&d<n&&(p.style.width="".concat(n<m?n:m,"px"),p.style.left="".concat(y-t,"px"));break;case"swst":t=g-e.clientX,o=x-e.clientY,n=t+h,i=o+_,s<y-t&&d<n&&(p.style.width="".concat(n<m?n:m,"px"),p.style.left="".concat(y-t,"px")),s<b-o&&f<i&&(p.style.height="".concat(i<v?i:v,"px"),p.style.top="".concat(b-o,"px"));break;case"swlb":t=g-e.clientX,o=e.clientY-x,n=t+h,i=o+_,s<y-t&&d<n&&(p.style.width="".concat(n<m?n:m,"px"),p.style.left="".concat(y-t,"px")),b+i+s<u&&f<i&&(p.style.height="".concat(i<v?i:v,"px"));break;case"st":o=x-e.clientY,i=_+o,s<b-o&&f<i&&(p.style.height="".concat(i<v?i:v,"px"),p.style.top="".concat(b-o,"px"));break;case"wr":t=e.clientX-g,y+(n=t+h)+s<c&&d<n&&(p.style.width="".concat(n<m?n:m,"px"));break;case"sest":t=e.clientX-g,i=(o=x-e.clientY)+_,y+(n=t+h)+s<c&&d<n&&(p.style.width="".concat(n<m?n:m,"px")),s<b-o&&f<i&&(p.style.height="".concat(i<v?i:v,"px"),p.style.top="".concat(b-o,"px"));break;case"selb":t=e.clientX-g,i=(o=e.clientY-x)+_,y+(n=t+h)+s<c&&d<n&&(p.style.width="".concat(n<m?n:m,"px")),b+i+s<u&&f<i&&(p.style.height="".concat(i<v?i:v,"px"));break;case"sb":o=e.clientY-x,b+(i=o+_)+s<u&&f<i&&(p.style.height="".concat(i<v?i:v,"px"))}p.className=p.className.replace(/\s?is--drag/,"")+" is--drag",a&&l&&V(),S.dispatchEvent("zoom",w,e)},document.onmouseup=function(){k.zoomLocat=null,document.onmousemove=o,document.onmouseup=n,setTimeout(function(){p.className=p.className.replace(/\s?is--drag/,"")},50)}},q=function(){var e=N.slots,t=void 0===e?{}:e,o=N.showClose,n=N.showZoom,i=N.title,a=k.zoomLocat,e=_.title||t.title,t=_.corner||t.corner,e=[(0,_vue.h)("div",{class:"vxe-modal--header-title"},e?(0,_vn.getSlotVNs)(e({$modal:z})):i?(0,_utils.getFuncText)(i):_conf.default.i18n("vxe.alert.title"))],i=[];return t&&i.push((0,_vue.h)("span",{class:"vxe-modal--corner-warpper"},(0,_vn.getSlotVNs)(t({$modal:z})))),n&&i.push((0,_vue.h)("i",{class:["vxe-modal--zoom-btn","trigger--btn",a?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],title:_conf.default.i18n("vxe.modal.zoom".concat(a?"Out":"In")),onClick:D})),o&&i.push((0,_vue.h)("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],title:_conf.default.i18n("vxe.modal.close"),onClick:l})),e.push((0,_vue.h)("div",{class:"vxe-modal--header-right"},i)),e},Z=function(){var e=[];return"confirm"===N.type&&e.push((0,_vue.h)(_button.default,{ref:y,content:N.cancelButtonText||_conf.default.i18n("vxe.button.cancel"),onClick:o})),e.push((0,_vue.h)(_button.default,{ref:v,status:"primary",content:N.confirmButtonText||_conf.default.i18n("vxe.button.confirm"),onClick:t})),e},S={dispatchEvent:function(e,t,o){m(e,Object.assign({$modal:z,$event:o},t))},open:n,close:function(){return C("close")},getBox:O,getPosition:function(){if(!T.value){var e=O();if(e)return{top:e.offsetTop,left:e.offsetLeft}}return null},setPosition:function(e,t){var o;return T.value||(o=O(),_xeUtils.default.isNumber(e)&&(o.style.top="".concat(e,"px")),_xeUtils.default.isNumber(t)&&(o.style.left="".concat(t,"px"))),(0,_vue.nextTick)()},isMaximized:u,zoom:s,maximize:f,revert:c};Object.assign(z,S),(0,_vue.watch)(function(){return N.width},a),(0,_vue.watch)(function(){return N.height},a),(0,_vue.watch)(function(){return N.modelValue},function(e){e?n():C("model")}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){N.storage&&!N.id&&(0,_log.errLog)("vxe.error.reqProp",["modal.id"]),N.modelValue&&n(),a()}),N.escClosable&&_event.GlobalEvent.on(z,"keydown",i)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(z,"keydown"),L()});return z.renderVN=function(){var e=N.className,t=N.type,o=N.animat,n=N.loading,i=N.status,a=N.lockScroll,l=N.lockView,u=N.mask,c=N.resize,s=k.inited,r=k.zoomLocat,d=k.modalTop,f=k.contentVisible,m=k.visible,v=g.value;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!N.transfer||!s},[(0,_vue.h)("div",{ref:x,class:["vxe-modal--wrapper","type--".concat(t),e||"",((e={})["size--".concat(v)]=v,e["status--".concat(i)]=i,e["is--animat"]=o,e["lock--scroll"]=a,e["lock--view"]=l,e["is--resize"]=c,e["is--mask"]=u,e["is--maximize"]=r,e["is--visible"]=f,e["is--active"]=m,e["is--loading"]=n,e)],style:{zIndex:k.modalZindex,top:d?"".concat(d,"px"):null},onClick:p},[(0,_vue.h)("div",{ref:b,class:"vxe-modal--box",onMousedown:h},(r=N.slots,f=N.showZoom,m=N.draggable,n=T.value,e=_.header||(void 0===r?{}:r).header,d=[],N.showHeader&&(r={},m&&(r.onMousedown=U),f&&N.dblclickZoom&&"modal"===N.type&&(r.onDblclick=D),d.push((0,_vue.h)("div",__assign({class:["vxe-modal--header",{"is--draggable":m,"is--ellipsis":!n&&N.showTitleOverflow}]},r),e?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(e({$modal:z})):q()))),d.concat((m=N.slots,n=N.status,r=N.message,e=N.content||r,d=T.value,r=_.default||(void 0===m?{}:m).default,m=[],n&&m.push((0,_vue.h)("div",{class:"vxe-modal--status-wrapper"},[(0,_vue.h)("i",{class:["vxe-modal--status-icon",N.iconStatus||_conf.default.icon["MODAL_".concat(n).toLocaleUpperCase()]]})])),m.push((0,_vue.h)("div",{class:"vxe-modal--content"},r?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(r({$modal:z})):(0,_utils.getFuncText)(e))),d||m.push((0,_vue.h)(_index.default,{class:"vxe-modal--loading",modelValue:N.loading})),[(0,_vue.h)("div",{class:"vxe-modal--body"},m)]),(e=N.slots,d=T.value,m=_.footer||(void 0===e?{}:e).footer,e=[],N.showFooter&&e.push((0,_vue.h)("div",{class:"vxe-modal--footer"},m?!k.inited||N.destroyOnClose&&!k.visible?[]:(0,_vn.getSlotVNs)(m({$modal:z})):Z())),!d&&N.resize&&e.push((0,_vue.h)("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(function(e){return(0,_vue.h)("span",{class:"".concat(e,"-resize"),type:e,onMousedown:H})}))),e))))])])},z},render:function(){return this.renderVN()}});exports.default=_default2;