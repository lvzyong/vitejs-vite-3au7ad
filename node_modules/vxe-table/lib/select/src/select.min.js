"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event"),_input=_interopRequireDefault(require("../../input/src/input")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default2=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:null,clearable:Boolean,placeholder:String,loading:Boolean,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:function(){return _conf.default.select.multiCharOverflow}},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,optionConfig:Object,className:[String,Function],max:{type:[String,Number],default:null},size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},filterable:Boolean,filterMethod:Function,remote:Boolean,remoteMethod:Function,emptyText:String,optionId:{type:String,default:function(){return _conf.default.select.optionId}},optionKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},emits:["update:modelValue","change","clear"],setup:function(x,e){function g(e,t){return e&&(_xeUtils.default.isString(e)&&(e=L[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[]}function v(t){var e=k.fullOptionList,n=k.fullGroupList,i=H.value,o=$.value;if(i)for(var l=0;l<n.length;l++){var u=n[l];if(u.options)for(var r=0;r<u.options.length;r++){var a=u.options[r];if(t===a[o])return a}}return e.find(function(e){return t===e[o]})}function o(t){var e=k.remoteValueList,n=F.value,e=(e=e.find(function(e){return t===e.key}))?e.result:null;return _xeUtils.default.toValueString(e?e[n]:t)}function l(e){var t=F.value,n=v(e);return _xeUtils.default.toValueString(n?n[t]:e)}function u(){var e=x.filterable,t=x.filterMethod,n=k.fullOptionList,i=k.fullGroupList,o=k.searchValue,l=H.value,u=B.value,r=F.value;return l?k.visibleGroupList=e&&t?i.filter(function(e){return isOptionVisible(e)&&t({group:e,option:null,searchValue:o})}):e?i.filter(function(e){return isOptionVisible(e)&&(!o||-1<"".concat(e[u]).indexOf(o))}):i.filter(isOptionVisible):k.visibleOptionList=e&&t?n.filter(function(e){return isOptionVisible(e)&&t({group:null,option:e,searchValue:o})}):e?n.filter(function(e){return isOptionVisible(e)&&(!o||-1<"".concat(e[r]).indexOf(o))}):n.filter(isOptionVisible),(0,_vue.nextTick)()}function n(){function t(e){J(e)||(e[o]=getOptUniqueId())}var e=k.fullOptionList,n=k.fullGroupList,i=z.value,o=X();n.length?n.forEach(function(e){t(e),e[i]&&e[i].forEach(t)}):e.length&&e.forEach(t),u()}function E(e){var t=$.value;e&&(k.currentOption=e,k.currentValue=e[t])}function p(i,o){return(0,_vue.nextTick)().then(function(){var e,t,n;i&&(e=K.value,t=U.value.querySelector("[optid='".concat(J(i),"']")),e&&t&&(n=e.offsetHeight,o?t.offsetTop+t.offsetHeight-e.scrollTop>n&&(e.scrollTop=t.offsetTop+t.offsetHeight-n):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5)))})}function i(){return(0,_vue.nextTick)().then(function(){var e=x.transfer,t=x.placement,n=k.panelIndex,i=A.value,o=U.value;if(o&&i){var l=i.offsetHeight,u=i.offsetWidth,r=o.offsetHeight,a=o.offsetWidth,s={zIndex:n},c=(0,_dom.getAbsolutePos)(i),f=c.boundingTop,o=c.boundingLeft,n=c.visibleHeight,i=c.visibleWidth,c="bottom";return e?(e=f+l,"top"===t?(c="top",e=f-r):t||(n<e+r+5&&(c="top",e=f-r),e<5&&(c="bottom",e=f+l)),i<(o=o)+a+5&&(o-=o+a+5-i),o<5&&(o=5),Object.assign(s,{left:"".concat(o,"px"),top:"".concat(e,"px"),minWidth:"".concat(u,"px")})):"top"===t?(c="top",s.bottom="".concat(l,"px")):t||n<f+l+r&&5<f-l-r&&(c="top",s.bottom="".concat(l,"px")),k.panelStyle=s,k.panelPlacement=c,(0,_vue.nextTick)()}})}function f(e,t){ne(t,null),ee()}function O(e,t,n){var i=x.modelValue,o=x.multiple,l=k.remoteValueList;o?(o=void 0,o=i?-1===i.indexOf(t)?i.concat([t]):i.filter(function(e){return e!==t}):[t],(i=l.find(function(e){return e.key===t}))?i.result=n:l.push({key:t,result:n}),te(e,o)):(k.remoteValueList=[{key:t,result:n}],te(e,t),ee())}function t(e){var t=x.disabled,n=k.visiblePanel;t||n&&(n=U.value,((0,_dom.getEventTargetNode)(e,n).flag?i:ee)())}function r(e){var t,n=x.disabled,i=k.visiblePanel;n||(t=A.value,n=U.value,k.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,n).flag,i&&!k.isActivated&&ee())}function a(e){var t,n,i,o,l,u,r=x.clearable,a=x.disabled,s=k.visiblePanel,c=k.currentValue,f=k.currentOption;a||(u=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.TAB),t=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER),n=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE),i=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP),o=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN),l=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.DELETE),a=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR),u&&(k.isActivated=!1),s?n||u?ee():t?(e.preventDefault(),e.stopPropagation(),O(e,c,f)):i||o?(e.preventDefault(),f=(u=function(e,t){var n,i,o,l,u=k.visibleOptionList,r=k.visibleGroupList,a=H.value,s=$.value,c=z.value;if(a)for(var f=0;f<r.length;f++){var v=r[f],p=v[c],d=v.disabled;if(p)for(var _=0;_<p.length;_++){var b=isOptionVisible(h=p[_]),m=d||h.disabled;if(n||m||(n=h),l&&b&&!m&&(o=h,!t))return{offsetOption:o};if(e===h[s]){if(l=h,t)return{offsetOption:i}}else b&&!m&&(i=h)}}else for(_=0;_<u.length;_++){var h,m=(h=u[_]).disabled;if(n||m||(n=h),l&&!m&&(o=h,!t))return{offsetOption:o};if(e===h[s]){if(l=h,t)return{offsetOption:i}}else m||(i=h)}return{firstOption:n}}(c,i)).firstOption,(u=u.offsetOption)||v(c)||(u=f),E(u),p(u,o)):a&&e.preventDefault():(i||o||t||a)&&k.isActivated&&(e.preventDefault(),Q()),k.isActivated&&l&&r&&ne(e,null))}function s(){ee()}function c(){x.filterable&&(0,_vue.nextTick)(function(){var e=C.value;e&&e.focus()})}function d(){x.disabled||(k.isActivated=!0)}function _(){k.isActivated=!1}function b(e){k.searchValue=e}function m(){k.isActivated=!0}function h(e){e=e.$event,(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)&&(e.preventDefault(),e.stopPropagation())}function V(e){e.$event.preventDefault(),(k.visiblePanel?ee:Q)()}var T,L=e.slots,y=e.emit,S=(0,_vue.inject)("$xeform",null),P=(0,_vue.inject)("$xeformiteminfo",null),N=_xeUtils.default.uniqueId(),G=(0,_size.useSize)(x),k=(0,_vue.reactive)({inited:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],remoteValueList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentOption:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1,searchValue:"",searchLoading:!1}),A=(0,_vue.ref)(),I=(0,_vue.ref)(),C=(0,_vue.ref)(),K=(0,_vue.ref)(),U=(0,_vue.ref)(),w={refElem:A},q={xID:N,props:x,context:e,reactData:k,getRefMaps:function(){return w}},D={},R=(0,_vue.computed)(function(){return x.optionProps||{}}),j=(0,_vue.computed)(function(){return x.optionGroupProps||{}}),F=(0,_vue.computed)(function(){return R.value.label||"label"}),$=(0,_vue.computed)(function(){return R.value.value||"value"}),B=(0,_vue.computed)(function(){return j.value.label||"label"}),z=(0,_vue.computed)(function(){return j.value.options||"options"}),M=(0,_vue.computed)(function(){var e=x.modelValue,t=x.multiple,n=x.max;return!(!t||!n)&&(e?e.length:0)>=_xeUtils.default.toNumber(n)}),Y=(0,_vue.computed)(function(){return Object.assign({},_conf.default.select.optionConfig,x.optionConfig)}),H=(0,_vue.computed)(function(){return k.fullGroupList.some(function(e){return e.options&&e.options.length})}),W=(0,_vue.computed)(function(){return _xeUtils.default.toNumber(x.multiCharOverflow)}),Z=(0,_vue.computed)(function(){var e=x.modelValue,t=x.multiple,n=x.remote,i=W.value;if(e&&t){t=_xeUtils.default.isArray(e)?e:[e];return n?t.map(o).join(", "):t.map(function(e){e=l(e);return 0<i&&e.length>i?"".concat(e.substring(0,i),"..."):e}).join(", ")}return(n?o:l)(e)}),X=function(){return Y.value.keyField||x.optionId||"_X_OPTION_KEY"},J=function(e){e=e[X()];return e?encodeURIComponent(e):""},Q=function(){var e=x.loading,t=x.disabled,n=x.filterable;e||t||(clearTimeout(T),k.inited||(k.inited=!0),k.isActivated=!0,k.animatVisible=!0,n&&u(),setTimeout(function(){var e=x.modelValue,t=x.multiple,e=v(t&&e?e[0]:e);k.visiblePanel=!0,e&&(E(e),p(e)),c()},10),k.panelIndex<(0,_utils.getLastZIndex)()&&(k.panelIndex=(0,_utils.nextZIndex)()),i())},ee=function(){k.searchValue="",k.searchLoading=!1,k.visiblePanel=!1,T=window.setTimeout(function(){k.animatVisible=!1},350)},te=function(e,t){t!==x.modelValue&&(y("update:modelValue",t),D.dispatchEvent("change",{value:t},e),S&&P&&S.triggerItemEvent(e,P.itemConfig.field,t))},ne=function(e,t){k.remoteValueList=[],te(e,t),D.dispatchEvent("clear",{value:t},e)},ie=_xeUtils.default.debounce(function(){var e=x.remote,t=x.remoteMethod,n=k.searchValue;e&&t?(k.searchLoading=!0,Promise.resolve(t({searchValue:n})).then(function(){return(0,_vue.nextTick)()}).catch(function(){return(0,_vue.nextTick)()}).finally(function(){k.searchLoading=!1,u()})):u()},350,{trailing:!0}),oe=function(e,c){var f=x.optionKey,v=x.modelValue,p=x.multiple,d=k.currentValue,t=Y.value,_=F.value,b=$.value,m=H.value,h=t.useKey;return e.map(function(t,e){var n,i=t.slots,o=t.className,l=t[b],u=p?v&&-1<v.indexOf(l):v===l,r=!m||isOptionVisible(t),a=(s=u,n=c,!!t.disabled||(!(!n||!n.disabled)||!(!M.value||s))),s=J(t),i=i?i.default:null;return r?(0,_vue.h)("div",{key:h||f?s:e,class:["vxe-select-option",o?_xeUtils.default.isFunction(o)?o({option:t,$select:q}):o:"",{"is--disabled":a,"is--selected":u,"is--hover":d===l}],optid:s,onMousedown:function(e){0===e.button&&e.stopPropagation()},onClick:function(e){a||O(e,l,t)},onMouseenter:function(){a||E(t)}},i?g(i,{option:t,$select:q}):(0,_utils.formatText)((0,_utils.getFuncText)(t[_]))):null})},le=function(){var u=x.optionKey,e=k.visibleGroupList,t=Y.value,r=B.value,a=z.value,s=t.useKey;return e.map(function(e,t){var n=e.slots,i=e.className,o=J(e),l=e.disabled,n=n?n.default:null;return(0,_vue.h)("div",{key:s||u?o:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i({option:e,$select:q}):i:"",{"is--disabled":l}],optid:o},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},n?g(n,{option:e,$select:q}):(0,_utils.getFuncText)(e[r])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},oe(e[a]||[],e))])})},D={dispatchEvent:function(e,t,n){y(e,Object.assign({$select:q,$event:n},t))},isPanelVisible:function(){return k.visiblePanel},togglePanel:function(){return(k.visiblePanel?ee:Q)(),(0,_vue.nextTick)()},hidePanel:function(){return k.visiblePanel&&ee(),(0,_vue.nextTick)()},showPanel:function(){return k.visiblePanel||Q(),(0,_vue.nextTick)()},refreshOption:u,focus:function(){var e=I.value;return k.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur:function(){return I.value.blur(),(k.isActivated=!1,_vue.nextTick)()}};Object.assign(q,D),(0,_vue.watch)(function(){return k.staticOptions},function(e){e.some(function(e){return e.options&&e.options.length})?(k.fullOptionList=[],k.fullGroupList=e):(k.fullGroupList=[],k.fullOptionList=e||[]),n()}),(0,_vue.watch)(function(){return x.options},function(e){k.fullGroupList=[],k.fullOptionList=e||[],n()}),(0,_vue.watch)(function(){return x.optionGroups},function(e){k.fullOptionList=[],k.fullGroupList=e||[],n()}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){var e=x.options,t=x.optionGroups;t?k.fullGroupList=t:e&&(k.fullOptionList=e),n()}),_event.GlobalEvent.on(q,"mousewheel",t),_event.GlobalEvent.on(q,"mousedown",r),_event.GlobalEvent.on(q,"keydown",a),_event.GlobalEvent.on(q,"blur",s)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(q,"mousewheel"),_event.GlobalEvent.off(q,"mousedown"),_event.GlobalEvent.off(q,"keydown"),_event.GlobalEvent.off(q,"blur")});return q.renderVN=function(){var e=x.className,t=x.transfer,n=x.disabled,i=x.loading,o=x.filterable,l=k.inited,u=k.isActivated,r=k.visiblePanel,a=G.value,s=Z.value,c=L.prefix;return(0,_vue.h)("div",{ref:A,class:["vxe-select",e?_xeUtils.default.isFunction(e)?e({$select:q}):e:"",((e={})["size--".concat(a)]=a,e["is--visivle"]=r,e["is--disabled"]=n,e["is--filter"]=o,e["is--loading"]=i,e["is--active"]=u,e)]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},L.default?L.default({}):[]),(0,_vue.h)(_input.default,{ref:I,clearable:x.clearable,placeholder:x.placeholder,readonly:!0,disabled:n,type:"text",prefixIcon:x.prefixIcon,suffixIcon:i?_conf.default.icon.SELECT_LOADED:r?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,modelValue:s,onClear:f,onClick:V,onFocus:d,onBlur:_,onSuffixClick:V},c?{prefix:function(){return c({})}}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!t||!l},[(0,_vue.h)("div",{ref:U,class:["vxe-table--ignore-clear vxe-select--panel",((s={})["size--".concat(a)]=a,s["is--transfer"]=t,s["animat--leave"]=!i&&k.animatVisible,s["animat--enter"]=!i&&r,s)],placement:k.panelPlacement,style:k.panelStyle},l?[o?(0,_vue.h)("div",{class:"vxe-select-filter--wrapper"},[(0,_vue.h)(_input.default,{ref:C,class:"vxe-select-filter--input",modelValue:k.searchValue,clearable:!0,placeholder:_conf.default.i18n("vxe.select.search"),prefixIcon:_conf.default.icon.INPUT_SEARCH,"onUpdate:modelValue":b,onFocus:m,onKeydown:h,onChange:ie,onSearch:ie})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{ref:K,class:"vxe-select-option--wrapper"},function(){var e=k.visibleGroupList,t=k.visibleOptionList,n=k.searchLoading,i=H.value;if(n)return[(0,_vue.h)("div",{class:"vxe-select--search-loading"},[(0,_vue.h)("i",{class:["vxe-select--search-icon",_conf.default.icon.SELECT_LOADED]}),(0,_vue.h)("span",{class:"vxe-select--search-text"},_conf.default.i18n("vxe.select.loadingText"))])];if(i){if(e.length)return le()}else if(t.length)return oe(t);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},x.emptyText||_conf.default.i18n("vxe.select.emptyText"))]}())]:[])])])},(0,_vue.provide)("$xeselect",q),q},render:function(){return this.renderVN()}});exports.default=_default2;